<!DOCTYPE html>
<!-- Pratik Pokhrel 101487514 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { margin: 0; height: 100vh; background: #f0f0f0; }
    .header { background: #0d6efd; color: white; padding: 10px 20px; display: flex; justify-content: space-between; }
    .main { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 200px; background: white; padding: 15px; border-right: 1px solid #ddd; }
    .chatbox { flex: 1; display: flex; flex-direction: column; background: white; }
    #messages { flex: 1; overflow-y: auto; padding: 15px; }
    .msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 8px; max-width: 70%; }
    .mymsg { background: #0d6efd; color: white; margin-left: auto; }
    .othermsg { background: #e9ecef; }
    .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
    #joinDiv { flex: 1; display: flex; align-items: center; justify-content: center; background: #f0f0f0; }
    #joinDiv .card { width: 350px; }
    #chatDiv { display: none; flex: 1; flex-direction: column; }
    #chatDiv.show { display: flex; }
    #typing { font-size: 12px; color: gray; font-style: italic; }
  </style>
</head>
<body>
  <div class="header">
    <span>Chat App</span>
    <div>
      <span id="userLabel"></span>
      <button class="btn btn-light btn-sm ms-2" id="leaveBtn" style="display:none">Leave Room</button>
      <button class="btn btn-light btn-sm ms-1" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div id="joinDiv">
    <div class="card">
      <div class="card-body">
        <p>Logged in as: <strong id="usernameShow"></strong></p>
        <div class="mb-2">
          <label class="form-label">Pick a room</label>
          <select class="form-select" id="roomSelect">
            <option value="">-- choose --</option>
          </select>
        </div>
        <div class="mb-2" id="newRoomDiv" style="display:none">
          <label class="form-label">New room name</label>
          <input type="text" class="form-control" id="newRoomInput" placeholder="type room name...">
        </div>
        <button class="btn btn-primary" id="joinBtn">Join</button>
      </div>
    </div>
  </div>

  <div id="chatDiv">
    <div class="main">
      <div class="sidebar">
        <div id="roomName" class="fw-bold mb-2">Room: -</div>
        <div>Members:</div>
        <ul id="membersList"></ul>
      </div>
      <div class="chatbox">
        <div id="messages"></div>
        <div id="typing" class="d-none"></div>
        <div class="input-area">
          <input type="text" class="form-control" id="msgInput" placeholder="type message...">
          <button class="btn btn-primary" id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var user = JSON.parse(localStorage.getItem('chat_user') || '{}');
    if (!user.username) {
      window.location = 'login.html';
    }

    var socket = null;
    var currentRoom = null;
    var typingTimer;

    $('#userLabel').text('Hi ' + user.username);
    $('#usernameShow').text(user.username);

    // get rooms
    $.get('/api/rooms', function(r) {
      if (r.rooms) {
        r.rooms.forEach(function(room) {
          $('#roomSelect').append($('<option>').val(room).text(room));
        });
        $('#roomSelect').append($('<option>').val('__new__').text('+ Create new room'));
      }
    });

    $('#roomSelect').change(function() {
      if ($(this).val() === '__new__') {
        $('#newRoomDiv').show();
        $('#newRoomInput').val('');
      } else {
        $('#newRoomDiv').hide();
      }
    });

    function connect() {
      if (socket && socket.connected) return socket;
      socket = io();
      
      socket.on('join_success', function(d) {
        currentRoom = d.room;
        $('#roomName').text('Room: ' + d.room.replace(/_/g, ' '));
        $('#membersList').empty();
        if (d.members) d.members.forEach(function(m) { $('#membersList').append('<li>' + m + '</li>'); });
        $('#joinDiv').hide();
        $('#chatDiv').addClass('show');
        $('#leaveBtn').show();
        $('#logoutBtn').hide();
      });

      socket.on('leave_success', function() {
        currentRoom = null;
        $('#chatDiv').removeClass('show');
        $('#joinDiv').show();
        $('#leaveBtn').hide();
        $('#logoutBtn').show();
        $('#messages').empty();
        $('#roomSelect').val('');
        $('#newRoomDiv').hide();
      });

      socket.on('room_history', function(msgs) {
        msgs.forEach(function(m) { addMsg(m, m.from_user === user.username); });
      });

      socket.on('group_message', function(m) {
        addMsg(m, m.from_user === user.username);
      });

      socket.on('user_joined', function(d) {
        $('#membersList').empty();
        if (d.members) d.members.forEach(function(m) { $('#membersList').append('<li>' + m + '</li>'); });
        addMsg({ from_user: 'system', message: d.username + ' joined', date_sent: '' }, false);
      });

      socket.on('user_left', function(d) {
        $('#membersList').empty();
        if (d.members) d.members.forEach(function(m) { $('#membersList').append('<li>' + m + '</li>'); });
        addMsg({ from_user: 'system', message: d.username + ' left', date_sent: '' }, false);
      });

      socket.on('user_typing', function(d) {
        $('#typing').removeClass('d-none').text(d.username + ' is typing...');
      });

      socket.on('user_stop_typing', function() {
        $('#typing').addClass('d-none');
      });

      socket.on('error', function(d) {
        alert(d.message || 'Error');
      });

      return socket;
    }

    function addMsg(m, isMe) {
      if (m.from_user === 'system') {
        $('#messages').append('<div class="msg othermsg" style="max-width:100%"><i>' + m.message + '</i></div>');
      } else {
        var cls = isMe ? 'mymsg' : 'othermsg';
        $('#messages').append('<div class="msg ' + cls + '"><b>' + m.from_user + '</b><br>' + m.message + '<br><small>' + m.date_sent + '</small></div>');
      }
      $('#messages').scrollTop($('#messages')[0].scrollHeight);
    }

    $('#joinBtn').click(function() {
      var room;
      if ($('#roomSelect').val() === '__new__') {
        room = $('#newRoomInput').val().trim();
        if (!room) { alert('enter room name'); return; }
      } else {
        room = $('#roomSelect').val();
        if (!room) { alert('pick a room'); return; }
      }
      connect();
      var r = room.toLowerCase().replace(/\s/g, '_');
      socket.emit('join_room', { username: user.username, room: r });
    });

    $('#leaveBtn').click(function() {
      if (socket && currentRoom) socket.emit('leave_room');
    });

    $('#msgInput').keydown(function() {
      if (socket && currentRoom) {
        socket.emit('typing');
        clearTimeout(typingTimer);
        typingTimer = setTimeout(function() { socket.emit('stop_typing'); }, 1200);
      }
    });

    function send() {
      var txt = $('#msgInput').val().trim();
      if (!txt || !socket || !currentRoom) return;
      socket.emit('group_message', { message: txt });
      $('#msgInput').val('');
      socket.emit('stop_typing');
    }

    $('#msgInput').keypress(function(e) {
      if (e.which === 13) send();
    });
    $('#sendBtn').click(send);

    $('#logoutBtn').click(function() {
      if (socket && currentRoom) socket.emit('leave_room');
      localStorage.removeItem('chat_user');
      window.location = 'login.html';
    });
  </script>
</body>
</html>
